/*
T h a n k M r G o o s e
h
a
n
k
M
r
G
o
o
s
e
+++++++o+oooooooooooooooooo++o++sydysydNNNNNNNMNNNNNNmNmmmmmddmmdyso++++++++++++++++++++++++++++++++
++++++++++oooooooooooooooooooo+oysyhhdmNNNMMMMMMMNNNmNNNNmmmmddddmmhso++++++++++++++++++++++++++++++
+++++++oooooooooooooooo/+o+++/syydNNmNNMMMNNMMMMMMNNNMMNNNmmmmmmNmmmmds+++++++++++++++++++++++++++++
++++oo+oooooooooooooo+ooy+++++sydmNNMMMMMNNNMMMMMMNNMMNNNNNmNmmmmNmmdmddyo++++++++++++++++++++++++++
+++oooooooooooooooooo+syyyysydmmNNNMMMMMMMMMMMMMMMMMMNNNNNNdmmmddddddmmmmds+++++++++++++++++++++++++
+++++oo+o+o+oo++oooo+oohddmmNNNNNMMMNNNNNMMNNNMNNNMMNNNNNNmdhdhddmmmmmNNNNNy++++++++++++++++++++++++
++++++++++++++o+o+o+oyhdmmNNmmmmNNmddhdddddhhdmmmmmmddmmdddddddddddddmmmNNMMh+++++++++++++++++++++++
++++++++++++++++++++oydmmmdyyyyhhysssoooo++//++++++++////+++osyhhhhhdhdNNNMMMy++++++++++++++++++++++
+++++++++++++++++++:syhddo:/+sssoo++///////::::::::::::::::::///oyhhhddmNNMMMNy+++++++++++++++++++++
+++++++++++++++++++:o+ys:.-:+oo++/////:/::::------------:::::::::/sydddmmNMMMMNs++++++++++++++++++++
++++++++++++++++++++:/s-..-:+++///:::::::---------.....----::::::://oymNNmNMMMMd++++++++++++++++++++
++++++++++++++++++++/o...-/+++///:::::::---.--...........----:::::::/+ymNNNMMMMMs+++++++++++++++++++
++++++++++++++++++++o/.../+o++//:/:::-::---..--...........----::::/::/odNNNMNNMMd+++++++++++++++++++
++++++++++++++++++++o...-+o++/+//::--:::---...-.......`....---::::/:://yNNmNNMMNm+++++++++++++++++++
+++++++++++++++++++/o``.-+o++/++/::-:---:-----..............---:::::::/+dNNNNMMMNo++++++++++++++++++
+++++++++++++++++++:/`..-+o++////::-/:-::---.....`..........----::::://+hmmNNMMMNo++++++++++++++++++
++++++++++++++++++/-:`.-:+o+++///:::::-::-....`...-::////:---:::::::///+ydmNNNNMMo++++++++++++++++++
++++++++++++++++++/:+.--:+oosssso++//:://-.-::/++syyydddddhs/:::::::/:/+hmmNNmNMNs++++++++++++++++++
+++++++++++++++++++/o-:-:shdmmdddddhyoso/-./dddddddhddhhhhhddhs+::::/:/+dNNNNNmNNh++++++++++++++++++
+++++++++++++++++++/s-::odmNNNNNNNNNmmmy/-.:shhddddhhyssssssydmhsossosyhNMMMMMNNNms+++++++++++++++++
+++++++++++++++++++sh/-sdmdhdddmdmmmmNms/:-:/+shyyyosNmmmhhhyohNNMMMmmNNMMMMMmhyosso++++++++++++++++
+++++++++++++++++++hdoohmdmNdhNNhmssymNdysshs+osyys+/so++/+syhdMMMNmmdyhmNNMNh++osso++++++++++++++++
+++++++++++++++++++hmoohmNNmhydhyo/+ydy/:-.:hs/:++++//:----:++yhhyso+///smmmds::/://o+++++++++++++++
+++++++++++++++++++hm+oyhyysoo++/:/oyyo/:--:+h:----::--------/+::///////+yhhy+.-/:::o+++++++++++++++
++++++++++++++++++++s+-++++++///:::oyyo/-----/+:-..--:::://///:-::::://+++oo+s--/::+++++++++++++++++
+++++++++++++++++++++o/:/+///::::/oyhhs/:-----::/++++++++/--..--::::/:/+++o+/o+:/-/+++++++++++++++++
+++++++++++++++++++++//-/sssooooosydhhs+:------:::///::--...----::::://+++++///-::++++++++++++++++++
+++++++++++++++++++++/-./++/::-::/ohhds+:--------:/:/syo/:-----::::::/+//++++/:::/++++++++++++++++++
++++++++++++++++++++++.-+++/::::/sdsohs/--.----:/o+/-/sdhy+/:::::::/:/+///+++:://+++++++++++++++++++
++++++++++++++++++++++::+++////oymNdhhho/:::/oysso+o/+shyhdhs//:::::://///++o/::++++++++++++++++++++
++++++++++++++++++++++/ossoo+sydmNNNNMMNmddhddy+++yssyydhhddmy+::::::://///+o/::++++++++++++++++++++
++++++++++++++++++++++syhysoyNmmmmmmmNNNNNmhddhooosyshdhmdmddd+:-:::://////++/++++++++++++++++++++++
++++++++++++++++++++++shhhsohNNmNNNNNNmmdhyos+++++ooosyhmhsyho:--::-::///+//+oo+++++++++++++++++++++
++++++++++++++++++++++oydds++ydNMMNNNmdhyysoo/::::..`.-+o--/y/-----::://++//+o++++++++++++++++++++++
+++++++++++++++++++++++yhdhs/-:ohmmNNmo+-:..-```.-..:++/---/s/::--::://++///+o++++++++++++++++++++++
+++++++++++++++++++++++oyyhhs/::+shhddhs:+--.`-`.-/o++:-.--/+//:::////+++///oo++++++++++++++++++++++
++++++++++++++++++++++++syyhhs+:/syhhhhhsoo++++:--::-------://++//+//++/////o+++++++++++++++++++++++
+++++++++++++++++++++++++ohhddy+/osyyyyysoo+++/:-.....---.--:/oo++//+++/::/+o.++++++++++++++++++++++
++++++++++++++++++++++++++ohddmhooosyysss+///:::--....----.-/oo++//+++/:::/++ /so++++++++++++++++o++
++++++++++++++++++++++++++++ydmmhssossssoo+//::--....------/oo+///+o+::-:/+:` `hdo++++++++++++++o+o+
+++++++++++++++++++++++++++++ohmdhsoooooo++//::::---------/ss+///+++::-://.    omdo+++++++++++++++++
+++++++++++++++++++++++++++++++yddhsooosso+/////-.--...-:+so+////++/:://:     `hmNms++++++++++o+o+++
++++++++++++++++++++++++++++++++sdmhysoooo+////++:--::/+sso+//////////:`      sdmmNmy++++++++o+oooo+
+++++++++++++++++++++++++++++++++oyddhhysoo+//oo++++oosso+++////////-`       +hmmmmmmdo+++++++o++ooo
++++++++++++++++++++++++++++++++++:sddddhhyyssyyyyyyyso+++//////+/-         ohdmmmddmmmyo++++++++ooo
++++++++++++++++++++++++++++++++++./dhhddddddddhhyso++++++/////-`         `ohddmmddddddmdyo+++o+oooo

*/

// import dependencies
const
	bodyParser = require('body-parser'), // parses request body into req.body
	cookieParser = require('cookie-parser'),
	cookieSession = require('cookie-session'),
	express = require('express'), // server framework
	favicon = require('serve-favicon'),
	fs = require('fs'),
	logger = require('morgan'),
	mongoose = require('mongoose'), // mongodb driver for nodejs
	path = require('path'),
	rfs = require('rotating-file-stream'),
	app = express(),
	port = normalizePort(process.env.PORT || '4000'), // setting default port
	logDirectory = path.join(__dirname, 'logs') // set log directory

// view engine setup
app.set('views', path.join(__dirname, 'views'))
app.set('view engine', 'ejs')

// port set up
app.set('port', port)

// proxy, used for sessions
app.set('trust proxy', 1) // trust first proxy

// writing logs
fs.existsSync(logDirectory) || fs.mkdirSync(logDirectory)

// serve favicon
app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')))

// logger setup
app.use(logger('dev'))
app.use(logger('common', {
	stream: rfs('server.log', {
		interval: '1d',
		path: logDirectory,
	}),
}))

// bodyparser set up, parses json and urlencoded requests
app.use(bodyParser.json())
app.use(bodyParser.urlencoded({ extended: false }))

// setup cookies
app.use(cookieParser())
app.use(cookieSession({
	name: 'env',
	secret: 'thankmrgoose',
}))

// tells server where to serve static files
app.use(express.static(path.join(__dirname, 'public')))

// connect to database
mongoose.connect(process.env.MONGODB_URL || 'mongodb://localhost:27017/dashboard', { useMongoClient: true })

// top level routes, for more detail, see ./routes
app.use('/db', require('./routes/REST'))
app.use('/', require('./routes/index'))


// catch 404 and forward to error handler
app.use((req, res, next) => {
	const err = new Error('Not Found')
	err.status = 404
	next(err)
})

// error handler
app.use((err, req, res, next) => {
	// set locals, only providing error in development
	res.locals.message = err.message
	res.locals.error = req.app.get('env') === 'development' ? err : {}

	// render the error page
	err.status = err.status || 500
	res.status(err.status)
	console.log(err)
	if (err.status === 500)
		res.send(err.message)
	else
		res.render('error')
})

// start listening
app.listen(port, () => console.log('Server started on port ' + port))

// helper function to make sure port number is right
function normalizePort (val) {
	const port = parseInt(val, 10)

	if (isNaN(port))
		return val


	if (port >= 0)
		return port


	return false
}
